<!--
Inventory of vulnerabilities and their associated risk factors;
Vulnerability reports convey risks associated with the use of specific versions of components in which a vulnerability exists.

FILTERS:
    -   Period
    -   Entities
    -   Has Fix/No Fix
    -   Severity

DIMENSIONS
    -   Entities
    -   Component

METRICS
    -   Entity
    -   Component
    -   Severity
    -   CVSS2 Score
    -   CVSS Score
    -   Fix version
-->

<h1 *ngIf="!displayDataOnly">Vulnerabilities Report</h1>

<!-- FILTER -->
<div class="report-filter" *ngIf="!displayDataOnly">

    <form class="form-inline1" action="javascript:">

        <div class="report-filter-row">
            <!-- date interval -->

            <!--<app-date-interval-filter></app-date-interval-filter>

            <app-entity-tree-filter></app-entity-tree-filter>-->


            <!--<div>
                <label>Fix</label>
                <select name="fixFilter" class="form-control custom-select" [(ngModel)]="fixFilter">
                    <option value="ALL" selected>- All -</option>
                    <option value="HASFIX">Has Fix</option>
                    <option value="NOFIX">No Fix</option>
                </select>
            </div>-->

            <div>
                <label>Severity</label>
                <select name="severityFilter" class="form-control custom-select" [(ngModel)]="severityFilter">
                    <option value="ALL" selected>- All -</option>
                    <option value="CRITICAL">CRITICAL</option>
                    <option value="HIGH">HIGH</option>
                    <option value="MEDIUM">MEDIUM</option>
                    <option value="LOW">LOW</option>
                    <option value="INFO">INFO</option>
                </select>
            </div>


            <div>
                <label>CVE ID</label>
                <input name="vulns" class="form-control" [(ngModel)]="vulnsFilter" style="width: 350px !important;" placeholder="Search specific vulnerabiluty by CVE..." />
            </div>



            <button type="submit" class="btn btn-info" (click)="onApplyFilter()">
                <i class="feather icon-filter"></i>
                Filter
            </button>
            <button type="submit" class="btn btn-warning" (click)="onClearFilter()">
                <i class="feather icon-slash"></i>
                Clear
            </button>
        </div>


        <!--<div class="report-filter-row filter-actions">
            <button type="submit" class="btn btn-info">
                <i class="feather icon-filter"></i>
                Filter
            </button>
            <button type="submit" class="btn btn-warning" (click)="onClearFilter()">
                <i class="feather icon-slash"></i>
                Clear
            </button>
        </div>-->


    </form>
</div>



<!-- ACTIONS -->
<div class="report-primary-actions" *ngIf="!displayDataOnly">
    <h2>Report actions</h2>
    <button class="btn btn-lg btn-outline-secondary" (click)="openPreview()"><i class="fas fa-search"></i> Preview report</button>
    <button class="btn btn-lg btn-outline-danger" disabled title="coming soon..."><i class="fas fa-file-pdf"></i> Export to PDF</button>
    <button class="btn btn-lg btn-outline-success" disabled title="coming soon..."><i class="fas fa-file-excel"></i> Export to Excel</button>
    <button class="btn btn-lg btn-outline-secondary" disabled title="coming soon..."><i class="fas fa-file-csv"></i> Export to CSV</button>
</div>



<!-- PREVIEW -->
<h2 class="report-data-preview-caption">Vulnerabilities Report data preview</h2>
<div #reportPreview class="report-preview {{previewStateOpen ? 'open' : ''}}">

    <div class="report-preview-close" *ngIf="!displayDataOnly">
        <i class="feather icon-x-square" (click)="closePreview()"></i>
    </div>

    <div class="container">

        <!-- logos -->
        <div class="report-logos" *ngIf="!displayDataOnly">
            <div class="row">
                <div class="col-sm-6">
<!--                    <img src="/assets/reports/shiftleft-logo.png" alt="" class="img-fluid">-->
                </div>
                <div class="col-sm-6">
<!--                    <img src="/assets/images/website_logo_white-letters-transparent_background.png" alt="" class="img-fluid">-->
                </div>
            </div>
        </div>

        <!-- TITLE -->
        <div class="report-title">
            Vulnerabilities<span *ngIf="!displayDataOnly"> Report</span>
            <div class="report-date" *ngIf="!displayDataOnly">{{reportDate | date:'longDate'}}</div>
        </div>


        <!-- TOTALS -->
        <div class="report-totals" *ngIf="totals">

            <!-- CARDS -->
            <div class="row justify-content-center">
                <div class="col-md-3">
                    <app-card [hidHeader]="true" cardClass="social-widget-card" blockClass="bg-total">
                        <h3 class="text-white m-0">{{totals.entities}}</h3>
                        <span class="m-t-10">Entities</span>
                        <i class="far fa-building"></i>
                    </app-card>
                </div>

                <div class="col-md-3">
                    <app-card [hidHeader]="true" cardClass="social-widget-card" blockClass="bg-total">
                        <h3 class="text-white m-0">{{totals.projects}}</h3>
                        <span class="m-t-10">Projects</span>
                        <i class="fas fa-cubes"></i>
                    </app-card>
                </div>

                <div class="col-md-3">
                    <app-card [hidHeader]="true" cardClass="social-widget-card" blockClass="bg-total">
                        <h3 class="text-white m-0">{{totals.vulnerabilities}}</h3>
                        <span class="m-t-10">Vulnerabilities</span>
                        <i class="fas fa-exclamation-triangle"></i>
                    </app-card>
                </div>
            </div>

            <div class="severities">
                <label>Vulnerabilities by severity</label>

                <span class="badge m-r-5 badge-light-danger" title="Critical">{{totals.severities['CRITICAL'] ? totals.severities['CRITICAL'] : 0}}</span>
                CRITICAL

                <span class="badge m-r-5 badge-light-warning" title="High">{{totals.severities['HIGH'] ? totals.severities['HIGH'] : 0}}</span>
                HIGH

                <span class="badge m-r-5 badge-light-success" title="Medium">{{totals.severities['MEDIUM'] ? totals.severities['MEDIUM'] : 0}}</span>
                MEDIUM

                <span class="badge m-r-5 badge-light-info" title="Low">{{totals.severities['LOW'] ? totals.severities['LOW'] : 0}}</span>
                LOW

                <span class="badge m-r-5 badge-light-primary" title="Info">{{totals.severities['INFO'] ? totals.severities['INFO'] : 0}}</span>
                INFO
            </div>
        </div>


        <div class="report-data">


            <ng-template ngFor let-entity [ngForOf]="entities" let-i="index">
                <div class="entity-caption">{{entity.entityName}} / {{entity.projectName}}</div>

                <div class="vulnerabilites-data">
                    <ul>
                        <li *ngFor="let vulData of entity.vulnerabilities" class="data-item {{vulData?.severity}}">

                            <div class="row">
                                <div class="col-sm-10 col-xs-12">
                                    <div class="vulner-data-lt">
                                        <div class="cursor-pointer">
                                            <div class="data-tag-ttl">
                                                <label class="data-tag  mr-1" style="background: none; color: inherit;">
                                                    <!-- {{vulData?.severity}} -->
                                                    <span [ngClass]="{'hidden' : vulData?.severity != 'NONE'}"
                                                          class="badge m-r-5 badge-light-info"
                                                          style="line-height: 22px;width: 56px;">{{vulData?.severity}}</span>
                                                    <span [ngClass]="{'hidden' : vulData?.severity !== 'LOW'}"
                                                          class="badge m-r-5 badge-light-primary"
                                                          style="line-height: 22px;width: 56px;">{{vulData?.severity}}</span>
                                                    <span [ngClass]="{'hidden' : vulData?.severity !== 'MEDIUM'}"
                                                          class="badge m-r-5 badge-light-warning"
                                                          style="line-height: 22px;width: 56px;">{{vulData?.severity}}</span>
                                                    <span [ngClass]="{'hidden' : vulData?.severity !== 'HIGH'}"
                                                          class="badge m-r-5 badge-light-danger"
                                                          style="line-height: 22px;width: 56px;">{{vulData?.severity}}</span>
                                                    <span [ngClass]="{'hidden' : vulData?.severity !== 'CRITICAL'}"
                                                          class="badge m-r-5 badge-light-danger"
                                                          style="line-height: 22px;width: 56px;">{{vulData?.severity}}</span>
                                                </label>
                                                <label class="data-tag blue-tag mr-1">{{vulData?.vulnSource}}</label>
                                                <span class="data-code ml-2"> {{vulData?.vulnId}}</span>

                                                <p class="data-hdng">{{vulData?.component}}</p>
                                            </div>

                                            <div class="data-row">
                                                <label class="data-tag purple-tag mr-2">{{vulData?.cweId}}</label>
                                                <p>{{vulData?.cweName}}</p>
                                            </div>

                                            <div class="data-row">
                                                <div class="info-cols mr-5">
                                                    <small>CVSS2:</small> {{vulData?.cvss2}}
                                                </div>

                                                <div class="info-cols mr-5">
                                                    <small>CVSS3:</small> {{vulData?.cvss3}}
                                                </div>

                                                <div class="info-cols mr-5">
                                                    <small>Published:</small>{{vulData?.published | date}}
                                                </div>

                                                <!--<div *ngIf="vulData?..updated" class="info-cols mr-5">
                                                    <small>Updated:</small>{{vulData?.updated | date}}
                                                </div>-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--<div class="col-sm-2 col-xs-12">
                                    <div class="vulner-data-rt">
                                        <div class="info-cols">
                                            <small>Fixed Versions</small> 2.9.9.1, 2.8.11.4, 2.7.9.6
                                        </div>

                                        <div class="action-btns mt-2">
                                            <a class="data-cta ingore-cta">Ignore</a>
                                            <a *ngIf="vulData?..components?.edges.length >= 1"
                                               (click)="fixVersion(vulData?..components?.edges[0].node.componentId,vulData?..components?.edges[0].node.version)"
                                               class="data-cta ml-2">Fix</a>
                                        </div>
                                    </div>
                                </div>-->
                            </div>

                        </li>
                    </ul>
                </div>

                <!--<p-table [columns]="columns" [value]="entity.entityComponents.edges" [paginator]="false" [rows]="50"
                         tableStyleClass="table table-striped table-bordered table-hover dataTable no-footer"
                         [autoLayout]="true" >

                    <ng-template pTemplate="header" let-columns>
                        <tr>
                            <th *ngFor="let col of columns" [pSortableColumn]="col.field">
                                {{col.header}}
                                <p-sortIcon [field]="col.field" ariaLabel="Activate to sort" ariaLabelDesc="Activate to sort in descending order" ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
                            </th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-component let-columns="columns">
                        &lt;!&ndash; [routerLink]="['/dashboard/project/vulnerability', vulnerability.node.vulnerabilityId]" &ndash;&gt;
                        <tr *ngFor="let vulnerability of component.node?.entityComponentVulnerabilities.edges">
                            <td><span class="badge m-r-5 badge-light-info">{{vulnerability.node?.source}}</span> {{vulnerability.node?.vulnId}}</td>
                            <td>{{component.node?.name}}</td>
                            <td>{{component.node?.group}}</td>
                            <td>{{component.node?.version}}</td>
                            <td><span *ngIf="vulnerability.node?.cwe"> CWE-{{vulnerability.node?.cwe?.cweId}} : {{vulnerability.node?.cwe?.name}}</span></td>
                            <td>{{vulnerability.node?.severity}}</td>
                            <td>{{vulnerability.node?.cvssV2BaseScore}}</td>
                            <td>{{vulnerability.node?.cvssV3BaseScore | number : '1.1-1'}}</td>
                            &lt;!&ndash;<td>{{vulnerability.node?.patchedVersions | number : 'unknown'}}</td>&ndash;&gt;
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage" let-columns>
                        <tr>
                            <td [attr.colspan]="columns.length" class="no-padding">
                                <app-alert type="success"><i class="far fa-smile-beam"></i>&nbsp;&nbsp;No vulnerabilities found</app-alert>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>-->
            </ng-template>

        </div>



    </div>
</div>
