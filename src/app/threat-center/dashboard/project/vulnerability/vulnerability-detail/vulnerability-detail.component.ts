import {Component, Input, OnDestroy, OnInit} from '@angular/core';
import {ActivatedRoute, Router} from '@angular/router';
import {Observable} from 'rxjs';
import {map} from 'rxjs/operators';
import {NgbModal, NgbTabChangeEvent} from '@ng-bootstrap/ng-bootstrap';
import {ApiService, StateService} from '@app/threat-center/shared/services';
import {CoreHelperService} from '@app/core/services/core-helper.service';
import {FixService} from "@app/threat-center/dashboard/project/services/fix.service";
import {FixComponentDialogComponent} from "@app/threat-center/dashboard/project/fix-component-dialog/fix-component-dialog.component";
import { FixResult, Vulnerability } from '@app/models';
import { ProjectBreadcumsService } from '@app/core/services/project-breadcums.service';

@Component({
  selector: 'vulnerability-detail',
  templateUrl: './vulnerability-detail.component.html',
  styles: []
})
export class VulnerabilityDetailComponent implements OnInit, OnDestroy {

  scanId;
  obsVulnerability: Observable<Vulnerability>;
  componentColumns = ['Name', 'Group', 'Version', 'Internal', 'Licenses', 'Vulnerabilities'];

  fixResultObservable: Observable<FixResult[]>;
  newVersion: string;

  projectId: string = "";
  breadcumDetail: any = {};
  constructor(
    private apiService: ApiService,
    private stateService: StateService,
    private route: ActivatedRoute,
    private router: Router,
    private fixService: FixService,
    private coreHelperService: CoreHelperService,
    private modalService: NgbModal,
    private projectBreadcumsService:ProjectBreadcumsService) { }


  ngOnInit() {
    console.log("Loading VulnerabilityDetailComponent");
    let vulnerabilityId = this.route.snapshot.paramMap.get('vulnerabilityId');
    this.projectId = this.route.snapshot.paramMap.get('projectId');
    console.log("vulnerabilityId:", vulnerabilityId);
    this.scanId = this.route.snapshot.paramMap.get('scanId');
    this.obsVulnerability = this.apiService.getVulnerability(vulnerabilityId)
      .pipe(map(result => result.data.vulnerability));
    this.initBreadcum();
  }
  ngOnDestroy(): void {
    if (!!this.projectBreadcumsService.getProjectBreadcum()) {
      this.projectBreadcumsService.settingProjectBreadcum("", "", "", false);
    }
  }

  onTabChange($event: NgbTabChangeEvent) {
    this.stateService.vulnerability_tabs_selectedTab = $event.nextId;
  }

  fixVersion(componentId: string, oldVersion: string) {
    const  modalRef = this.modalService.open(FixComponentDialogComponent, {
      keyboard: false,
    });
    modalRef.componentInstance.scanId = this.scanId;
    modalRef.componentInstance.newVersion = this.newVersion;
    modalRef.componentInstance.oldVersion = oldVersion;
    modalRef.componentInstance.componentId = componentId;
  }

  public releaseCols = ['Name', 'Version'];
  public releases = [
    { version: '2.12.1', date: 'Jan 09, 2021' },
    { version: '2.12.0', date: 'Nov 29, 2020' },
    { version: '2.12.0-rc2', date: 'Nov 15, 2020' },
    { version: '2.12.0-rc1', date: 'Oct 12, 2020' },
    { version: '2.11.4', date: 'Dec 12, 2020' },
    { version: '2.11.3', date: 'Oct 02, 2020' },
    { version: '2.11.2', date: 'Aug 02, 2020' },
    { version: '2.11.1', date: 'Jun 25, 2020' },
    { version: '2.11.0', date: 'Apr 26, 2020' },
    { version: '2.11.0.rc1', date: 'Mar 24, 2020' },
    { version: '2.10.5.1', date: 'Dec 02, 2020' },
    { version: '2.10.5', date: 'Jul 21, 2020' },
    { version: '2.10.4', date: 'May 03, 2020' },
    { version: '2.10.3', date: 'Mar 03, 2020' },
    { version: '2.10.2', date: 'Jan 05, 2020' },
    { version: '2.10.1', date: 'Nov 09, 2019' },
    { version: '2.10.0', date: 'Sep 26, 2019' },
    { version: '2.10.0.pr3', date: 'Sep 17, 2019' },
    { version: '2.10.0.pr2', date: 'Aug 31, 2019' },
    { version: '2.10.0.pr1', date: 'Jul 19, 2019' },
    { version: '2.9.10.8', date: 'Jan 06, 2021' },
    { version: '2.9.10.7', date: 'Dec 02, 2020' },
    { version: '2.9.10.6', date: 'Aug 25, 2020' },
    { version: '2.9.10.5', date: 'Jun 22, 2020' },
    { version: '2.9.10.4', date: 'Apr 11, 2020' },
  ];

  gotoProject() {
    const entityId = this.route.snapshot.paramMap.get('entityId');
    const url = "dashboard/entity/" + entityId + "/project/" + this.projectId;
    this.router.navigate([url]);
  }

  gotoComponent() {
    const entityId = this.route.snapshot.paramMap.get('entityId');
    const url = "dashboard/entity/" + entityId + "/project/" + this.projectId + "/component/" + this.breadcumDetail.SelectedComponent['id'];
    this.router.navigate([url]);
  }

  //Initialize breadcum details
  private initBreadcum() {
    this.breadcumDetail = this.projectBreadcumsService.getProjectBreadcum();
  }
}
