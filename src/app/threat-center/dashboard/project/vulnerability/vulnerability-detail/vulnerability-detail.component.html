
<div *ngIf='obsVulnerability | async as vulnerability; '>
  <div class="row" style="margin-bottom:20px">
    <div class="col-md-12" *ngIf="!!breadcumDetail">
      <span style="font-size:15px">
          <a class="cursor-pointer" [routerLink]="['/dashboard/entity']"><i class="far fa-building"></i>&nbsp;{{breadcumDetail.SelectedEntity?.name}}</a> /
          <a class="cursor-pointer" (click)="gotoProject()">{{breadcumDetail.SelectedProject.name}}</a> /
          <a class="cursor-pointer" *ngIf="breadcumDetail.IsFromComponent && !!breadcumDetail.SelectedComponent" (click)="gotoComponent()">{{breadcumDetail.SelectedComponent.name}}</a> <span *ngIf="breadcumDetail.IsFromComponent && !!breadcumDetail.SelectedComponent"> / </span>
          <span style="color: #ffffff;">{{vulnerability.vulnId}}</span></span>
      </div>

  </div>
  <div class="row">
    <div class="col-md-6">
      <h3>
        <span class="badge m-r-5 badge-light-primary">{{vulnerability.source}}</span>
        <span [ngClass]="{'hidden' : vulnerability.severity != 'NONE'}" class="badge m-r-5 badge-light-info">{{vulnerability.severity}}</span>
        <span [ngClass]="{'hidden' : vulnerability.severity !== 'LOW'}" class="badge m-r-5 badge-light-primary ">{{vulnerability.severity}}</span>
        <span [ngClass]="{'hidden' : vulnerability.severity !== 'MEDIUM'}" class="badge m-r-5 badge-light-warning ">{{vulnerability.severity}}</span>
        <span [ngClass]="{'hidden' : vulnerability.severity !== 'HIGH'}" class="badge m-r-5 badge-light-danger ">{{vulnerability.severity}}</span>
        <span [ngClass]="{'hidden' : vulnerability.severity !== 'CRITICAL'}" class="badge m-r-5 badge-light-danger ">{{vulnerability.severity}}</span>
        {{vulnerability.vulnId}}
      </h3>
      Published: <span title="Info" class="badge m-r-5 badge-light-primary">{{vulnerability.published  | date :'MMMM d, y h:mm'}}</span>
      Updated: <span title="Info" class="badge m-r-5 badge-light-primary">{{vulnerability.updated | date :'MMMM d, y h:mm'}}</span>
    </div>
  </div>

  <div class="row m-t-50">
    <div class="col-md-12">
      <ngb-tabset type="pills" [activeId]="stateService.vulnerability_tabs_selectedTab" (tabChange)="onTabChange($event)">

        <!-- DETAILS TAB -->
        <ngb-tab title="Details" id="details">
          <ng-template ngbTabContent>

            <!-- CWE -->
            <div style="display: flex;">
              <div class="card m-3" style="flex: 40%;" *ngIf="vulnerability.cwe">
                <div class="card-body" >
                  <h5 class="card-title">
                    <span class="badge m-r-10 badge-light-primary">CWE-{{vulnerability.cwe.cweId}}</span>
                    <a href="https://cwe.mitre.org/data/definitions/{{vulnerability.cwe.cweId}}.html">{{vulnerability.cwe.name}}</a>
                  </h5>
                </div>
              </div>
            </div>

            <div style="display: flex;">

              <div class="card m-3" style="flex: 45%;">
                <div class="card-body">
                  <h5 class="card-title">Description</h5>
                  <p class="card-text">{{vulnerability.description}}</p>
                  <!--<p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>-->
                </div>
              </div>

              <div class="card m-3" style="flex: 55%;">
                <div class="card-body">
                  <h5 class="card-title"><span title="Critical" class="badge m-r-5 badge-light-success">SAST VECTOR META DATA</span><span style="font-size:12px">[example data]</span></h5>

                  <form class="m-t-20">
                    <div class="form-group row ">
                      <label for="file" class="col-sm-3 col-form-label">File</label>
                      <div class="col-sm-9">
                        <input type="text" class="form-control" id="file" readonly placeholder="http.conn.ssl.SSLConnectionSocketFactory.java">
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="method" class="col-sm-3 col-form-label">Method</label>
                      <div class="col-sm-9">
                        <input type="text" class="form-control" id="method" readonly placeholder="private http.conn.ssl.SSLConnection getConnection(http.conn.ssl.SSLRequest)">
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="lineNumber" class="col-sm-3 col-form-label">Line Number</label>
                      <div class="col-sm-9">
                        <input type="text" class="form-control" id="lineNumber" readonly placeholder="327">
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div style="display: flex;">
              <div class="card m-3" style="flex: 30%;">
                <div class="card-body">


                  <h5 class="card-title">
                  <span [ngClass]="{'hidden' : vulnerability.severity != 'NONE'}" class="badge m-r-5 badge-light-info">CVSS3</span>
                  <span [ngClass]="{'hidden' : vulnerability.severity !== 'LOW'}" class="badge m-r-5 badge-light-primary ">CVSS3</span>
                  <span [ngClass]="{'hidden' : vulnerability.severity !== 'MEDIUM'}" class="badge m-r-5 badge-light-warning ">CVSS3</span>
                  <span [ngClass]="{'hidden' : vulnerability.severity !== 'HIGH'}" class="badge m-r-5 badge-light-danger ">CVSS3</span>
                  <span [ngClass]="{'hidden' : vulnerability.severity !== 'CRITICAL'}" class="badge m-r-5 badge-light-danger ">CVSS3</span>
                  </h5>
                  <div class="card-text f-18">base score: {{vulnerability.cvssV3BaseScore}}</div>
                  <div class="card-text">cvssV3ImpactSubScore: {{vulnerability.cvssV3ImpactSubScore}}</div>
                  <div class="card-text">cvssV3ExploitabilitySubScore: {{vulnerability.cvssV3ExploitabilitySubScore}}</div>
                  <div class="card-text">cvssV3Vector: {{vulnerability.cvssV3Vector}}</div>
                </div>
              </div>

              <div class="card m-3" style="flex: 30%;">
                <div class="card-body">

                  <h5 class="card-title">
                    <span [ngClass]="{'hidden' : vulnerability.cvssV2BaseScore >= 4}" class="badge m-r-5 badge-light-primary ">CVSS2</span>
                    <span [ngClass]="{'hidden' : vulnerability.cvssV2BaseScore < 4 || vulnerability.cvssV2BaseScore >= 7 }" class="badge m-r-5 badge-light-warning ">CVSS2</span>
                    <span [ngClass]="{'hidden' : vulnerability.cvssV2BaseScore < 7}" class="badge m-r-5 badge-light-danger ">CVSS2</span>
                  </h5>

                  <div class="card-text f-18">base score: {{vulnerability.cvssV2BaseScore}}</div>
                  <div class="card-text">cvssV2ImpactSubScore: {{vulnerability.cvssV2ImpactSubScore}}</div>
                  <div class="card-text">cvssV2ExploitabilitySubScore: {{vulnerability.cvssV2ExploitabilitySubScore}}</div>
                  <div class="card-text">cvssV2Vector: {{vulnerability.cvssV2Vector}}</div>
                </div>
              </div>

              <!-- NPM data -->
              <div class="card m-3" style="flex: 30%;">
                <div class="card-body">
                  <h5 class="card-title"><span title="Critical" class="badge m-r-5 badge-light-primary">NPM DETAILS</span></h5>
                  <div class="card-text f-18">title: {{vulnerability.title}}</div>
                  <div class="card-text">subtitle: {{vulnerability.subtitle}}</div>
                  <div class="card-text">vulnerableVersions: {{vulnerability.vulnerableVersions}}</div>
                  <div class="card-text">patchedVersions: {{vulnerability.patchedVersions}}</div>
                  <div class="card-text">recommendation: {{vulnerability.recommendation}}</div>
                </div>
              </div>

            </div>

            <div style="display: flex;">
              <div class="card m-3" style="flex: 70%;">
                <div class="card-body">
                  <h5 class="card-title">References</h5>
                  <p class="card-text">
                    <markdown>
                      {{vulnerability.references}}
                    </markdown>
                  </p>
                  <!--<p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>-->
                </div>
              </div>
            </div>

          </ng-template>
        </ngb-tab>

        <!-- COMPONENTS TAB -->
        <ngb-tab title="Affected Components" id="components">
          <ng-template ngbTabContent>

            <!-- TAB HEADER -->
            <div style="display: flex;">
              <div class="card m-3">
                <div class="card-body">
                  <h5 class="card-title">
                    Project Components Affected By <span class="badge m-l-5 badge-light-primary">{{vulnerability.vulnId}}</span>
                  </h5>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-3 col-lg-4" *ngFor="let component of vulnerability.components.edges">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title"> {{component.node.group}} : {{component.node.name}}</h6>
                    <div class="row">
                      <div class="col-sm-6">
                        <form>
                          <div class="form-group row">
                            <label for="currentVer" class="col-sm-12 col-form-label">Current Version</label>
                            <div class="col-xl-12">
                              <input type="text" class="form-control" id="currentVer" readonly placeholder="{{component.node.version}}">
                            </div>
                          </div>
                          <div class="form-group row">
                            <label for="fixVer" class="col-sm-12 col-form-label">Latest Secure Version</label>
                            <div class="col-xl-12">
                              <input type="text" class="form-control" id="fixVer" readonly
                                placeholder="{{getPatchedInfo(component.node.componentId, false)}}">
                            </div>
                          </div>
                          <div class="form-group row">
                            <label for="fixVer" class="col-sm-12 col-form-label">Next Secure Version</label>
                            <div class="col-xl-12">
                              <input type="text" class="form-control" id="fixVer" readonly
                                placeholder="{{getPatchedInfo(component.node.componentId, true)}}">
                            </div>
                          </div>
                
                          <div style="margin-left: 5px;">
                            <button class="btn btn-outline-primary " data-toggle="modal" type="button"
                              (click)="$event.stopPropagation();fixVersion(component.node.componentId,component.node.version)">Fix</button>
                          </div>
                        </form>
                      </div>
                      <div class="col-sm-6">
                        <perfect-scrollbar *ngIf="binaryData.get(component.node.componentId)" [style.max-height]="'410px'" class="overflowshadowTop"
                          #perfectScrollBinaryRelease (psYReachEnd)="loadBinaryReleasesLazy($event, component.node.componentId)">
                          <p-table #dtBinary [columns]="releaseCols"
                            [value]="binaryData.get(component.node.componentId).vulnerableReleases" [scrollable]="false" [rows]="25"
                            [style]="{width:'100%'}" scrollHeight="373px" [virtualScroll]="false" [virtualRowHeight]="34" [lazy]="false"
                            tableStyleClass="table table-striped table-bordered table-hover dataTable no-footer table-width">
                            <ng-template pTemplate="colgroup">
                              <colgroup>
                                <col style="width:50%">
                                <col style="width:50%">
                              </colgroup>
                            </ng-template>
                            <ng-template pTemplate="header">
                              <tr>
                                <th style="width:50%">Version</th>
                                <th style="width:50%">Release Date</th>
                              </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-binaryRelease>
                              <tr *ngIf="binaryRelease.cvssV3 != null; else noCvssB" [placement]="'top'" style="height:34px"
                                ngbTooltip="{{binaryRelease.cvssV3.cveId}} : {{binaryRelease.cvssV3.cvssV3BaseScore}} : {{binaryRelease.cvssV3.severity}}">
                                <td style="width:63%">
                                  <span
                                    [ngClass]="[binaryRelease.cvssV3.severity == 'CRITICAL' ? 'badge m-r-5 badge-light-danger': 'badge m-r-5',
                                                              binaryRelease.cvssV3.severity === 'HIGH' ? 'badge m-r-5 badge-light-danger': 'badge m-r-5',
                                                              binaryRelease.cvssV3.severity === 'MEDIUM' ? 'badge m-r-5 badge-light-warning': 'badge m-r-5',
                                                              binaryRelease.cvssV3.severity === 'LOW' ? 'badge m-r-5 badge-light-primary': 'badge m-r-5',
                                                              binaryRelease.cvssV3.severity === 'INFO' ? 'badge m-r-5 badge-light-success': 'badge m-r-5']">
                                    {{binaryRelease.version}}
                                  </span>
                                </td>
                                <td style="width:37%">
                                  <span
                                    [ngClass]="[binaryRelease.cvssV3.severity == 'CRITICAL' ? 'badge m-r-5 badge-light-danger': 'badge m-r-5',
                                                              binaryRelease.cvssV3.severity === 'HIGH' ? 'badge m-r-5 badge-light-danger': 'badge m-r-5',
                                                              binaryRelease.cvssV3.severity === 'MEDIUM' ? 'badge m-r-5 badge-light-warning': 'badge m-r-5',
                                                              binaryRelease.cvssV3.severity === 'LOW' ? 'badge m-r-5 badge-light-primary': 'badge m-r-5',
                                                              binaryRelease.cvssV3.severity === 'INFO' ? 'badge m-r-5 badge-light-success': 'badge m-r-5']">
                                    {{binaryRelease.releaseDate}}
                                  </span>
                                </td>
                              </tr>
                              <ng-template #noCvssB>
                                <tr style="height:34px">
                                  <td style="width:63%"><span class="badge m-r-5">{{binaryRelease.version}}</span></td>
                                  <td style="width:37%"><span class="badge m-r-5">{{binaryRelease.releaseDate}}</span></td>
                                </tr>
                              </ng-template>
                            </ng-template>
                          </p-table>
                        </perfect-scrollbar>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
            </div>

          </ng-template>
        </ngb-tab>
        <!-- <ngb-tab title="Affected Projects" id="projects">
          <ng-template ngbTabContent>

          </ng-template>
        </ngb-tab> -->
      </ngb-tabset>
    </div>
  </div>
  <ngx-spinner [fullScreen]="true" color="#4680ff" type="pacman" size="large"></ngx-spinner>
</div>



